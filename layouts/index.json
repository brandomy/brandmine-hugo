{{- $index := slice -}}

{{- /* Load taxonomy labels for current language */ -}}
{{- $labels := dict -}}
{{- with $.Site.Data -}}
  {{- with index . "taxonomy-labels" -}}
    {{- with index . $.Language.Lang -}}
      {{- $labels = . -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- range .Site.Pages -}}
  {{- if and (eq .Section "brands") (eq .Language.Lang $.Language.Lang) .File -}}
    {{- $city := "" -}}
    {{- $region := "" -}}
    {{- with .Params.headquarters -}}
      {{- $city = .city | default "" -}}
      {{- $region = .region | default "" -}}
    {{- end -}}

    {{- /* Build translated taxonomy arrays */ -}}
    {{- $marketLabels := slice -}}
    {{- range .Params.markets -}}
      {{- $marketLabels = $marketLabels | append (index $labels.markets . | default .) -}}
    {{- end -}}

    {{- $sectorLabels := slice -}}
    {{- range .Params.sectors -}}
      {{- $sectorLabels = $sectorLabels | append (index $labels.sectors . | default .) -}}
    {{- end -}}

    {{- $attributeLabels := slice -}}
    {{- range .Params.attributes -}}
      {{- $attributeLabels = $attributeLabels | append (index $labels.attributes . | default .) -}}
    {{- end -}}

    {{- $signalLabels := slice -}}
    {{- range .Params.signals -}}
      {{- $signalLabels = $signalLabels | append (index $labels.signals . | default .) -}}
    {{- end -}}

    {{- $entry := dict
      "id" .File.UniqueID
      "title" .Title
      "description" (.Params.description | default (.Summary | plainify | truncate 150))
      "url" .Permalink
      "type" "brand"
      "lang" .Language.Lang
      "founded" (.Params.founded | default 0)
      "city" $city
      "region" $region
      "markets" $marketLabels
      "sectors" $sectorLabels
      "attributes" $attributeLabels
      "signals" $signalLabels
      "founder" (.Params.founder | default "")
    -}}
    {{- $index = $index | append $entry -}}
  {{- else if and (eq .Section "founders") (eq .Language.Lang $.Language.Lang) .File -}}
    {{- $city := "" -}}
    {{- $region := "" -}}
    {{- with .Params.headquarters -}}
      {{- $city = .city | default "" -}}
      {{- $region = .region | default "" -}}
    {{- end -}}

    {{- $entry := dict
      "id" .File.UniqueID
      "title" .Title
      "description" (.Params.description | default (.Summary | plainify | truncate 150))
      "url" .Permalink
      "type" "founder"
      "lang" .Language.Lang
      "city" $city
      "region" $region
      "company" (.Params.company | default "")
      "role" (.Params.role | default "")
      "expertise" (.Params.expertise | default slice)
    -}}
    {{- $index = $index | append $entry -}}
  {{- end -}}
{{- end -}}

{{- $index | jsonify -}}
